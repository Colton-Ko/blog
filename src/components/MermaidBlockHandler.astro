<script>
    import { animate } from "motion";
    import { createCopyButton } from "../utils/createCopyButton";

    /**
     * Initializes click handlers for mermaid blocks to enable expand/collapse functionality.
     * Finds all .mermaid elements and adds click handlers to show/hide mermaid source.
     */
    function initMermaidBlocks() {
        const mermaidBlocks = document.querySelectorAll(".mermaid");

        mermaidBlocks.forEach((mermaidBlock) => {
            // Skip if already wrapped
            if (
                mermaidBlock.parentElement?.classList.contains(
                    "mermaid-block-wrapper",
                )
            ) {
                return;
            }

            // Try to find the source code from multiple possible locations
            let mermaidSource: string | null = null;
            let sourceElement: Element | null = null;

            // Method 1: Check for source-view sibling
            const prevSibling = mermaidBlock.previousElementSibling;
            if (prevSibling && prevSibling.classList.contains("source-view")) {
                sourceElement = prevSibling;
                const sourceCode = sourceElement.querySelector("code");
                if (sourceCode) {
                    mermaidSource = sourceCode.textContent;
                }
            }

            // Method 2: Check parent wrapper for data-source attribute
            if (!mermaidSource) {
                let parent = mermaidBlock.parentElement;
                while (parent && !mermaidSource) {
                    if (parent.dataset && parent.dataset.source) {
                        mermaidSource = parent.dataset.source;
                        break;
                    }
                    parent = parent.parentElement;
                }
            }

            // Method 3: Check if there's a pre > code sibling
            if (!mermaidSource) {
                const preSibling = mermaidBlock.previousElementSibling;
                if (preSibling && preSibling.tagName === "PRE") {
                    const code = preSibling.querySelector("code");
                    if (code) {
                        mermaidSource = code.textContent;
                        sourceElement = preSibling;
                    }
                }
            }

            if (!mermaidSource) {
                console.warn(
                    "No mermaid source found for block:",
                    mermaidBlock,
                );
                return;
            }

            // Add click handler
            mermaidBlock.addEventListener("click", (e) => {
                e.stopPropagation();
                const isExpanded =
                    mermaidBlock.parentElement?.classList.contains(
                        "mermaid-block-wrapper",
                    );

                if (isExpanded) {
                    // Collapse - unwrap
                    const wrapper = mermaidBlock.parentElement;
                    if (!wrapper) return;

                    const header = wrapper.querySelector(".code-block-header");
                    const sourceDiv = wrapper.querySelector(".mermaid-source");

                    if (!header || !sourceDiv) return;

                    // Animate out
                    const animations = [
                        animate(
                            header,
                            { height: 0, opacity: 0 },
                            { duration: 0.3 },
                        ),
                        animate(
                            sourceDiv,
                            { height: 0, opacity: 0, padding: 0 },
                            { duration: 0.3 },
                        ),
                        animate(
                            wrapper,
                            {
                                backgroundColor: "rgba(0,0,0,0)",
                                borderColor: "rgba(0,0,0,0)",
                                borderWidth: 0,
                            },
                            { duration: 0.3 },
                        ),
                    ];

                    Promise.all(animations.map((a) => a.finished)).then(() => {
                        // Restore source-view before mermaid block if it exists
                        if (wrapper.parentNode) {
                            if (
                                sourceElement &&
                                (sourceElement as HTMLElement).style
                            ) {
                                (sourceElement as HTMLElement).style.display =
                                    "";
                            }
                            wrapper.parentNode.insertBefore(
                                mermaidBlock,
                                wrapper,
                            );
                            wrapper.remove();
                        }
                    });
                } else {
                    // Expand - wrap with header and source
                    const wrapper = document.createElement("div");
                    wrapper.className = "mermaid-block-wrapper";
                    // Initial wrapper styles
                    wrapper.style.borderWidth = "0px";
                    wrapper.style.backgroundColor = "transparent";
                    wrapper.style.overflow = "hidden";

                    // Create header
                    const header = document.createElement("div");
                    header.className = "code-block-header";
                    // Initial header styles
                    header.style.height = "0px";
                    header.style.opacity = "0";
                    header.style.overflow = "hidden";

                    const langLabel = document.createElement("span");
                    langLabel.className = "code-block-language";
                    langLabel.textContent = "mermaid";

                    const copyBtn = createCopyButton(
                        mermaidSource,
                        "Copy Mermaid to clipboard",
                    );

                    header.appendChild(langLabel);
                    header.appendChild(copyBtn);

                    // Create source code div
                    const sourceDiv = document.createElement("div");
                    sourceDiv.className = "mermaid-source";
                    // Initial source styles
                    sourceDiv.style.height = "0px";
                    sourceDiv.style.opacity = "0";
                    sourceDiv.style.overflow = "hidden";
                    sourceDiv.style.padding = "0px";

                    const code = document.createElement("code");
                    code.textContent = mermaidSource;
                    sourceDiv.appendChild(code);

                    // Hide the original source element if it exists
                    if (sourceElement && (sourceElement as HTMLElement).style) {
                        (sourceElement as HTMLElement).style.display = "none";
                    }

                    // Wrap
                    if (mermaidBlock.parentNode) {
                        mermaidBlock.parentNode.insertBefore(
                            wrapper,
                            mermaidBlock,
                        );
                        wrapper.appendChild(header);
                        wrapper.appendChild(sourceDiv);
                        wrapper.appendChild(mermaidBlock);
                    }

                    // Stop propagation on wrapper clicks
                    wrapper.addEventListener("click", (e) => {
                        e.stopPropagation();
                    });

                    // Trigger animation
                    animate(
                        header,
                        { height: "auto", opacity: 1 },
                        { duration: 0.3 },
                    );
                    animate(
                        sourceDiv,
                        { height: "auto", opacity: 1, padding: "1rem" },
                        { duration: 0.3 },
                    );
                    animate(
                        wrapper,
                        {
                            backgroundColor: "var(--color-gray-50)",
                            borderColor: "var(--color-gray-200)",
                            borderWidth: "1px",
                        },
                        { duration: 0.3 },
                    );
                }
            });
        });
    }

    // Initialize on page load and after View Transitions
    document.addEventListener("astro:page-load", initMermaidBlocks);
</script>
