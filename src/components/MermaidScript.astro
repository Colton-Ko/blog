<script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";

    mermaid.initialize({
        startOnLoad: false,
        theme: "default",
        securityLevel: "loose",
        fontFamily: "system-ui, sans-serif",
    });

    async function renderMermaid() {
        // Find all code blocks marked as mermaid
        const graphs = document.querySelectorAll("pre > code.language-mermaid");

        // Transform them to div.mermaid
        for (const graph of graphs) {
            const content = graph.textContent;
            const pre = graph.parentElement;

            // Create replacement div
            const div = document.createElement("div");
            div.classList.add("mermaid");
            div.textContent = content;

            // Replace pre with div
            if (pre && pre.parentNode) {
                pre.parentNode.replaceChild(div, pre);
            }
        }

        // Run mermaid on all .mermaid elements
        if (document.querySelector(".mermaid")) {
            await mermaid.run({
                querySelector: ".mermaid",
            });
        }
    }

    // Initial load
    renderMermaid();

    // View Transitions support
    document.addEventListener("astro:after-swap", renderMermaid);
</script>
