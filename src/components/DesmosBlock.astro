---
/**
 * DesmosBlock component - Interactive Desmos calculator with click-to-load
 *
 * @example
 * <DesmosBlock
 *   key="API_KEY"
 *   link="https://www.desmos.com/calculator/abc123"
 *   lang="en"
 * />
 */

import { generateDesmosHTML } from "./desmos-template.ts";
import { DEFAULT_LANGUAGE } from "../../config.language";

interface Props {
    key: string;
    state?: string;
    link?: string;
    lang?: string;
    height?: string;
    width?: string;
}

const {
    key,
    state = "",
    link,
    lang = DEFAULT_LANGUAGE,
    height = "500px",
    width = "100%",
} = Astro.props;

const uniqueId = `calculator-${Math.random().toString(36).substring(2, 9)}`;

// If link is provided, fetch the state (server-side)
let calculatorState = state;
if (link && !state) {
    try {
        const response = await fetch(link, {
            headers: { Accept: "application/json" },
        });
        if (response.ok) {
            const jsonData = await response.json();
            if (jsonData?.state) {
                calculatorState = JSON.stringify(jsonData.state);
            }
        }
    } catch (error) {
        console.error(
            `[DesmosBlock] Failed to fetch state from ${link}`,
            error,
        );
    }
}

// Generate HTML using shared template
const html = generateDesmosHTML({
    uniqueId,
    width,
    height,
    defaultLang: DEFAULT_LANGUAGE,
    key,
    state: calculatorState,
});
---

<!-- Resource hints for Desmos performance -->
<link rel="preconnect" href="https://www.desmos.com" />

<Fragment set:html={html} />

<script is:inline type="module">
    import { initDesmosWidget } from "/scripts/desmos-widget.js";

    // Get the uniqueId from the previous sibling or context?
    // Actually, we can't easily pass uniqueId without define:vars unless we generate the script content string.
    // But wait, we can just find the container we just rendered!
    // Or, we can keep define:vars just for uniqueId, which is much safer than passing large JSON state.

    // BETTER: Use a data attribute on the script tag itself? No.
    // Let's stick to define:vars ONLY for uniqueId, but read the rest from DOM.
    // This minimizes the data passed through JS.
</script>

<script is:inline type="module" define:vars={{ uniqueId }}>
    import { initDesmosWidget } from "/scripts/desmos-widget.js";
    initDesmosWidget(uniqueId);
</script>

<style is:global>
    /* Performance: Skip rendering off-screen Desmos content */
    .desmos-container {
        content-visibility: auto;
        contain-intrinsic-size: 1px 300px; /* Estimate height to prevent scrollbar jumping */
    }
</style>
