---
// Code Block Header Bar component
// Adds a header bar with language label and copy functionality to code blocks
---

<script>
    import { getCodeBlockHandlerTranslation } from "./CodeBlockHandlerTranslations";
    import { getDefaultLanguage } from "../../config.language";
    import { createCopyButton } from "../utils/createCopyButton";

    // Initialize code copy buttons globally
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    (window as any).initCodeCopyButtons = function (container = document) {
        // Find all pre elements that are not inside mermaid diagrams AND not inside source-view
        // If container is provided, search within it
        const preElements = container.querySelectorAll(
            "pre:not(.mermaid pre):not(.source-view pre)",
        );

        preElements.forEach((pre) => {
            // Skip if already wrapped or is a mermaid element
            if (
                pre.classList.contains("mermaid") ||
                pre.parentElement?.classList.contains("code-block-wrapper")
            ) {
                return;
            }

            // Extract language from code element class (e.g., "language-javascript")
            const code = pre.querySelector("code");
            let language = "text";
            if (code && code.className) {
                const match = code.className.match(/language-(\w+)/);
                if (match) {
                    language = match[1];
                }
            }

            // Skip mermaid blocks (handled by MermaidScript/MermaidBlockHandler)
            if (language === "mermaid") return;

            // Get current language translations
            const currentLang = localStorage.getItem("lang") || "us";
            const t =
                getCodeBlockHandlerTranslation(currentLang) ||
                getDefaultLanguage();

            // Create wrapper
            const wrapper = document.createElement("div");
            wrapper.className = "code-block-wrapper";

            // Create header
            const header = document.createElement("div");
            header.className = "code-block-header";

            // Create language label
            const langLabel = document.createElement("span");
            langLabel.className = "code-block-language";
            langLabel.textContent = language;

            // Create copy button using utility
            const text = code ? code.textContent : pre.textContent;
            if (!text) return;
            const button = createCopyButton(text, t.ariaLabel);

            // Assemble header
            header.appendChild(langLabel);
            header.appendChild(button);

            // Wrap the pre element
            if (pre.parentNode) {
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(header);
                wrapper.appendChild(pre);
            }
        });
    };

    // Initialize on page load
    document.addEventListener("astro:page-load", () =>
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        (window as any).initCodeCopyButtons(),
    );

    // Reinitialize when language changes
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    if (!(window as any).codeBlockCopyButtonLanguageListenerAdded) {
        window.addEventListener("language-change", () => {
            // Remove old wrappers
            document
                .querySelectorAll(".code-block-wrapper")
                .forEach((wrapper) => {
                    const pre = wrapper.querySelector("pre");
                    if (pre && wrapper.parentNode) {
                        wrapper.parentNode.insertBefore(pre, wrapper);
                        wrapper.remove();
                    }
                });
            // Reinitialize with new language
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            (window as any).initCodeCopyButtons();
        });
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        (window as any).codeBlockCopyButtonLanguageListenerAdded = true;
    }
</script>

<style>
    /* Code block wrapper */
    :global(.code-block-wrapper) {
        margin: var(--spacing-md) 0;
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--color-gray-200);
        background-color: var(--color-gray-50);
    }

    /* Math block wrapper when expanded */
    :global(.math-block-wrapper),
    :global(.mermaid-block-wrapper) {
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid transparent;
        border-width: 0;
        background-color: transparent;
        margin: var(--spacing-md) 0;
    }

    :global(.mermaid-source),
    :global(.math-latex-source) {
        background-color: var(--color-gray-50);
        padding: 0;
        font-family: "Courier New", Courier, monospace;
        font-size: 0.875rem;
        overflow-x: auto;
        overflow-y: auto;
        border-bottom: 1px solid var(--color-gray-200);
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    :global(.katex-display::-webkit-scrollbar),
    :global(.mermaid-source::-webkit-scrollbar) {
        display: none;
    }

    :global(.katex-display::-webkit-scrollbar):hover,
    :global(.mermaid-source::-webkit-scrollbar):hover {
        display: none;
    }

    :global(.katex-display):hover,
    :global(.mermaid:hover) {
        scrollbar-width: none;
        background-color: var(--color-dim-hover);
    }

    :global(.katex-display):hover::-webkit-scrollbar,
    :global(.mermaid:hover::-webkit-scrollbar) {
        display: none;
    }

    :global(.mermaid-source code),
    :global(.math-latex-source code) {
        background: none;
        padding: 0;
        white-space: pre;
        display: block;
        overflow-x: scroll;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    :global(.mermaid-source::-webkit-scrollbar),
    :global(.math-latex-source::-webkit-scrollbar) {
        display: none;
    }

    :global(.math-block-wrapper .katex-display):hover,
    :global(.mermaid-block-wrapper .mermaid:hover) {
        background-color: var(--color-dim-hover);
    }

    :global(.math-block-wrapper .katex-display),
    :global(.mermaid-block-wrapper .mermaid) {
        background-color: transparent;
        margin: 0;
        padding: var(--spacing-md);
        cursor: pointer;
        transition:
            background-color var(--transition-slow) ease-in-out,
            padding var(--transition-slow) ease-in-out;
    }

    :global(.katex-display),
    :global(.mermaid) {
        background-color: transparent;
        padding: var(--spacing-md) 0;
        border-radius: var(--radius-lg);
        -ms-overflow-style: none;
        scrollbar-width: none;
        cursor: pointer;
        overflow-x: auto;
        transition: background-color var(--transition-base) ease;
    }

    /* Mermaid diagrams */
    :global(.mermaid) {
        margin: var(--spacing-lg) auto;
        display: block;
        width: 100%;
        box-sizing: border-box;
        text-align: center;
    }

    :global(.mermaid-block-wrapper .mermaid) {
        box-sizing: border-box;
        display: block;
    }

    /* Code block header */
    :global(.code-block-header) {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: var(--spacing-md-sm);
        padding: var(--spacing-xs) var(--spacing-md-sm);
        background-color: var(--color-gray-200);
    }

    /* Language label */
    :global(.code-block-language) {
        font-size: 0.6875rem;
        font-weight: 600;
        color: var(--color-gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Copy button */
    :global(.code-block-copy-btn) {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xs);
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: var(--radius-md);
        color: var(--color-gray-500);
        cursor: pointer;
        transition: all var(--transition-base) ease;
    }

    :global(.code-block-copy-btn:hover) {
        background-color: var(--color-gray-300);
        color: var(--color-gray-700);
    }

    :global(.code-block-copy-btn:active) {
        transform: scale(0.95);
    }

    :global(.code-block-copy-btn.copied) {
        color: var(--color-success);
    }

    :global(.code-block-copy-btn.error) {
        color: var(--color-error);
    }

    /* Pre element inside wrapper */
    :global(.code-block-wrapper pre) {
        margin: 0;
        border-radius: 0;
        border: none;
    }

    /* Ensure consistent code block appearance */
    :global(.code-block-wrapper pre code) {
        display: block;
        padding: var(--spacing-md);
        overflow-x: auto;
    }

    /* Code blocks */
    :global(pre) {
        background-color: var(--color-gray-75) !important;
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
        overflow-x: auto;
        border: none !important;
        box-shadow: none !important;
        position: relative;
    }

    :global(pre code) {
        background-color: transparent !important;
        padding: 0 !important;
    }

    :global(code) {
        font-family: ui-monospace, monospace;
        font-size: 0.875em;
        background-color: var(--color-gray-75);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
    }

    /* Remove background from code inside pre */
    :global(pre code) {
        background-color: transparent;
        padding: 0;
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    :global(pre::-webkit-scrollbar) {
        display: none;
    }

    :global(code:hover) {
        scrollbar-width: auto;
    }

    :global(code:hover::-webkit-scrollbar) {
        display: block;
    }
</style>
