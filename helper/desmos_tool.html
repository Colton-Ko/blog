<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Desmos State Fetcher</title>
  <style>
    /* Flat Design & Reset */
    :root {
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --text-main: #212529;
      --text-secondary: #6c757d;
      --primary: #000000;
      --primary-hover: #333333;
      --border: #dee2e6;
      --error-bg: #ffe3e3;
      --error-text: #c92a2a;
      --code-bg: #f1f3f5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      padding: 2rem;
      margin: 0;
      line-height: 1.5;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 900px;
      background: var(--card-bg);
      padding: 2rem;
      border: 1px solid var(--border);
    }

    h1 {
      margin-top: 0;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    p.subtitle {
      color: var(--text-secondary);
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-size: 0.95rem;
    }

    /* Form Elements */
    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 1.5rem;
    }

    input[type="text"] {
      flex: 1;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 0;
      /* Flat */
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus {
      border-color: var(--primary);
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
      border-radius: 0;
      /* Flat */
      transition: opacity 0.2s;
    }

    button:hover {
      opacity: 0.9;
    }

    button:disabled {
      background-color: var(--text-secondary);
      cursor: not-allowed;
    }

    /* Toolbar Buttons */
    .toolbar {
      display: none;
      /* Hidden until data loads */
      gap: 10px;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .btn-secondary {
      background-color: white;
      color: var(--text-main);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .btn-secondary:hover {
      background-color: #f1f3f5;
    }

    /* Output Area */
    #output-area {
      display: none;
      /* Hidden until data loads */
    }

    pre {
      background-color: var(--code-bg);
      padding: 1rem;
      overflow-x: auto;
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.85rem;
      color: #333;
      border: 1px solid var(--border);
      max-height: 600px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* States */
    .error-box {
      background-color: var(--error-bg);
      color: var(--error-text);
      padding: 1rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--error-text);
      display: none;
    }

    .loading-text {
      display: none;
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 600px) {
      .input-group {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>Desmos State Fetcher</h1>
    <p class="subtitle">Plain JSON extractor. No visual clutter.</p>

    <form id="fetchForm">
      <div class="input-group">
        <input type="text" id="urlInput" placeholder="https://www.desmos.com/calculator/..." required>
        <button type="submit" id="fetchBtn">Get JSON</button>
      </div>
    </form>

    <div id="loadingText" class="loading-text">Fetching data...</div>
    <div id="errorBox" class="error-box"></div>

    <div id="output-area">
      <div class="toolbar">
        <button type="button" class="btn-secondary" id="prettifyBtn">Prettify</button>
        <button type="button" class="btn-secondary" id="minifyBtn">Minify</button>
        <button type="button" class="btn-secondary" id="downloadBtn">Download .json</button>
        <button type="button" class="btn-secondary" id="copyBtn">Copy to Clipboard</button>
      </div>
      <pre id="jsonDisplay"></pre>
    </div>
  </div>

  <script>
    // State variables
    let rawData = null;

    // DOM Elements
    const form = document.getElementById('fetchForm');
    const urlInput = document.getElementById('urlInput');
    const fetchBtn = document.getElementById('fetchBtn');
    const errorBox = document.getElementById('errorBox');
    const loadingText = document.getElementById('loadingText');
    const outputArea = document.getElementById('output-area');
    const toolbar = document.querySelector('.toolbar');
    const jsonDisplay = document.getElementById('jsonDisplay');
    const copyBtn = document.getElementById('copyBtn');

    // Logic
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Reset UI
      errorBox.style.display = 'none';
      outputArea.style.display = 'none';
      toolbar.style.display = 'none';
      loadingText.style.display = 'block';
      fetchBtn.disabled = true;
      rawData = null;

      const targetUrl = urlInput.value.trim();

      try {
        // Validation
        if (!targetUrl.includes('desmos.com/calculator/')) {
          throw new Error("Invalid URL. Must contain 'desmos.com/calculator/'");
        }

        // Proxy Fetch
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });

        if (!response.ok) {
          throw new Error(`Failed to fetch: ${response.status}`);
        }

        // Content Type check
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          const text = await response.text();
          if (text.trim().startsWith("<!DOCTYPE html")) {
            throw new Error("Received HTML. Desmos or Proxy rejected the request.");
          }
        }

        const data = await response.json();

        // Check specifically for the 'state' key
        if (!data || typeof data.state === 'undefined') {
          throw new Error("The returned JSON does not contain a 'state' key.");
        }

        // We only care about the state object
        rawData = data.state;

        // Success Render
        jsonDisplay.textContent = JSON.stringify(rawData, null, 2);
        outputArea.style.display = 'block';
        toolbar.style.display = 'flex';

      } catch (err) {
        errorBox.textContent = err.message;
        errorBox.style.display = 'block';
      } finally {
        loadingText.style.display = 'none';
        fetchBtn.disabled = false;
      }
    });

    // Toolbar Actions
    document.getElementById('prettifyBtn').addEventListener('click', () => {
      if (rawData) jsonDisplay.textContent = JSON.stringify(rawData, null, 2);
    });

    document.getElementById('minifyBtn').addEventListener('click', () => {
      if (rawData) jsonDisplay.textContent = JSON.stringify(rawData);
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      if (!rawData) return;
      const blob = new Blob([jsonDisplay.textContent], { type: 'application/json' });
      const href = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = href;
      link.download = `desmos_state_${Date.now()}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    copyBtn.addEventListener('click', () => {
      if (!jsonDisplay.textContent) return;

      const textArea = document.createElement("textarea");
      textArea.value = jsonDisplay.textContent;
      document.body.appendChild(textArea);
      textArea.select();

      try {
        document.execCommand('copy');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "Copied!";
        setTimeout(() => copyBtn.textContent = originalText, 2000);
      } catch (err) {
        console.error('Copy failed', err);
      }

      document.body.removeChild(textArea);
    });
  </script>
</body>

</html>